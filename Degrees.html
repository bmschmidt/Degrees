<!DOCTYPE html>
    <!-- adapted from url=(0040)http://bl.ocks.org/mbostock/raw/3885211/ -->
     <html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8">
     <style>

     body {
     font: 10px sans-serif;
 }

     .axis text {font-size: 14pt}

     .axis path,
     .axis line {
     fill: none;
     stroke: #000;
     shape-rendering: crispEdges;
 }

     .discipline text {
         text-anchor: end;
     }
     .selector{fill:black;opacity:.15}
     .highlit {fill:red;font-style:bold;opacity:1}


     </style>
         </head><body>
         <script src="./d3.v3.js"></script>
     <script>

     var margin = {top: 20, right: 320, bottom: 30, left: 100},
     width = window.innerWidth - margin.left - margin.right,
     height = window.innerHeight*4/5 - margin.top - margin.bottom;

var formatPercent = d3.format(".1%"),formatYear = d3.format("d");

var startYear = 1966;

var x = d3.scale.linear()
    .range([0, width])
    .domain([startYear,2011])
    .clamp(true);


d3.select("body").append("button").text("Start date: " + startYear).on("click",function(){
	if (startYear==1966) {startYear = 1947} else {
	    startYear = 1966}
	d3.select(this).text("Start date: " + startYear)
	    x.domain([startYear,2011])
	    update()
	    })


    
var y = d3.scale.linear()
    .range([height, 0]);

var fields = ["English", "History", "Languages", "Philosophy","All Others"];
var plottingFields = d3.set(fields);
plottingFields.remove("All Others");
var color = d3.scale.category10().domain(fields);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom")
    .tickFormat(formatYear);

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .tickFormat(function(n) {
     if (denominator=='dummy') {return d3.format('g')(n)}
     else {return formatPercent(n)}})

var area = d3.svg.area()
    .x(function(d) { return x(d.Year); })
    .y0(function(d) { return y(d.y0); })
    .y1(function(d) { return y(d.y0 + d.y); });

var stack = d3.layout.stack()
    .values(function(d) { return d.values; });

var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var fieldChoices = svg.append("g")
    .attr("id","fieldChoices")
    .attr("transform","translate(" + (width + margin.left) + ",20)");

var fieldnames = fieldChoices
    .selectAll("text")
    .data(fields);

var fieldChoiceScale = d3.scale.ordinal().domain(fields).rangePoints([500,300]);

fieldnames
    .enter()
    .append("text")
    .attr("y",function(d) {return fieldChoiceScale(d)})
    .text(function(d) {return d; console.log(d)})
    .style('fill',function(d) {return(color(d))})
    .style("font-size",36)
    .attr("class","fieldname selector")
    .classed("highlit",function(d) {return plottingFields.has(d)});

fieldnames.on("click",function(d) {
	if (plottingFields.has(d)) {
	    d3.select(this).classed('highlit',false);
	    plottingFields.remove(d)
		} else {
	    plottingFields.add(d);
	    d3.select(this).classed('highlit',true)
		}
	update()
    });

var numerator = "count", denominator = "total";

var counttypes = [
		  {"key":"Population","value":"% of 23-year-olds"},
		  {"key":"total","value":"% of BAs"},
		  {"key":"dummy","value":"Raw Number"}
		  ];

var countChoices = svg.append("g")
    .attr("id","fieldChoices");

var countnames = countChoices
    .selectAll("text")
    .data(counttypes);

var countChoiceScale = d3.scale.ordinal().domain(counttypes.map(function(d){return d.key})).rangePoints([height,150]);

countnames
    .enter()
    .append("text")
    .text(function(d) {return d.value; console.log(d)})
    .style("font-size",20)
    .attr("transform", function(d) {return ("translate(-80," + countChoiceScale(d.key) + ")rotate(270)")})
    .attr("class","axis selector")
    .classed("highlit",function(d) {return d.key==denominator})

countnames.on("click",function(d) {
	d3.selectAll(".axis.selector").classed("highlit",false);
	d3.select(this).classed("highlit",true);
	denominator = d.key;
	update();
    })


//debugging
var datasplore,disciplines2,mylect;

xaxis = svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")");

yaxis = svg.append("g")
    .attr("class", "y axis")
    .attr("transform", "translate(0,0)");

var dataPoints;
firstLoad = function() {
    d3.tsv("data.tsv", function(error, data) {
     data.map(function(d) {d.dummy=1});
            dataPoints = data;
	    update(150)
        })
};

var test;
var update = function(transtime,ydomain) {
    
    if (transtime===undefined) {transtime=4000}
    data = dataPoints;
    {
        var disciplines = stack(
				fields.map(
					   function(name) {
                    return {
                        name: name,
                        values: data.filter(function(d) {return (d.variable==name)})
			.map(function(d) {
				var y = 0;
				if (plottingFields.has(name)) {y= d[numerator] / d[denominator]}
                                return {Year: d.Year, y: y}
			    })}
		}))
	    test = disciplines;    

    if(ydomain===undefined) {
        y.domain([0,d3.max(disciplines.map(function(d) {return d3.max(d.values.map(function(e) {return e.y+e.y0}))}))])
	    } else {y.domain(ydomain)}


        var discipline = svg.selectAll(".area")
           .data(disciplines,function(d) {return d.name})


        discipline.enter().append('path').classed("area",true)
            .style("fill", function(d) { return color(d.name); })
     .attr("id",function(d) {return d.name});
	discipline
	    .transition().duration(transtime)
            .attr("d", function(d) { return area(d.values); })

        xaxis.transition().duration(transtime)
            .call(xAxis);

        yaxis.transition().duration(transtime)
            .call(yAxis);
    }
}
    firstLoad()
        </script>

